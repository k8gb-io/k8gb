name: Security Scan

on:
  schedule:
    # Run security scan daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type of scan to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - filesystem
          - config
          - secrets
      severity:
        description: 'Minimum severity level'
        required: true
        default: 'HIGH'
        type: choice
        options:
          - CRITICAL
          - HIGH,CRITICAL
          - MEDIUM,HIGH,CRITICAL
          - LOW,MEDIUM,HIGH,CRITICAL

permissions:
  contents: read
  security-events: write

jobs:
  security-scan:
    name: Comprehensive Security Scan
    runs-on: ubuntu-24.04
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Run Trivy filesystem scan
        if: ${{ github.event.inputs.scan_type == 'all' || github.event.inputs.scan_type == 'filesystem' || github.event_name == 'schedule' }}
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: 'fs'
          scan-ref: '.'
          trivy-config: trivy.yaml
          format: 'sarif'
          output: 'trivy-fs-results.sarif'
          severity: ${{ github.event.inputs.severity || 'HIGH,CRITICAL' }}

      - name: Upload filesystem scan results
        if: ${{ github.event.inputs.scan_type == 'all' || github.event.inputs.scan_type == 'filesystem' || github.event_name == 'schedule' }}
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: 'trivy-fs-results.sarif'
          category: 'trivy-filesystem'

      - name: Run Trivy configuration scan
        if: ${{ github.event.inputs.scan_type == 'all' || github.event.inputs.scan_type == 'config' || github.event_name == 'schedule' }}
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: 'config'
          scan-ref: '.'
          trivy-config: trivy.yaml
          format: 'sarif'
          output: 'trivy-config-results.sarif'
          severity: ${{ github.event.inputs.severity || 'HIGH,CRITICAL' }}

      - name: Upload configuration scan results
        if: ${{ github.event.inputs.scan_type == 'all' || github.event.inputs.scan_type == 'config' || github.event_name == 'schedule' }}
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: 'trivy-config-results.sarif'
          category: 'trivy-config'

      - name: Run Trivy Helm chart scan
        if: ${{ github.event.inputs.scan_type == 'all' || github.event.inputs.scan_type == 'config' || github.event_name == 'schedule' }}
        uses: aquasecurity/trivy-action@0.33.1
        env:
          TRIVY_SEVERITY: ${{ github.event.inputs.severity || 'MEDIUM,HIGH,CRITICAL' }}
        with:
          scan-type: 'config'
          scan-ref: 'chart/k8gb'
          trivy-config: trivy.yaml
          format: 'sarif'
          output: 'trivy-helm-results.sarif'

      - name: Upload Helm chart scan results
        if: ${{ github.event.inputs.scan_type == 'all' || github.event.inputs.scan_type == 'config' || github.event_name == 'schedule' }}
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: 'trivy-helm-results.sarif'
          category: 'trivy-helm-charts'

      - name: Run Trivy secret scan
        if: ${{ github.event.inputs.scan_type == 'all' || github.event.inputs.scan_type == 'secrets' || github.event_name == 'schedule' }}
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: 'fs'
          scan-ref: '.'
          trivy-config: trivy.yaml
          format: 'sarif'
          output: 'trivy-secret-results.sarif'
          scanners: 'secret'
          exit-code: '0'

      - name: Upload secret scan results
        if: ${{ github.event.inputs.scan_type == 'all' || github.event.inputs.scan_type == 'secrets' || github.event_name == 'schedule' }}
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: 'trivy-secret-results.sarif'
          category: 'trivy-secrets'

      - name: Generate security report
        if: always()
        run: |
          echo "# Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Scan Date**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Results have been uploaded to the Security tab." >> $GITHUB_STEP_SUMMARY