package controllers

/*
Copyright 2021-2025 The k8gb Contributors.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.

Generated by GoLic, for more details see: https://github.com/AbsaOSS/golic
*/

import (
	"context"
	"testing"

	k8gbv1beta1 "github.com/k8gb-io/k8gb/api/v1beta1"
	"github.com/k8gb-io/k8gb/controllers/resolver"
	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/require"
	corev1 "k8s.io/api/core/v1"
	discov1 "k8s.io/api/discovery/v1"
	metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"
	"k8s.io/apimachinery/pkg/runtime"
	"sigs.k8s.io/controller-runtime/pkg/client/fake"
)

func TestGetLoadBalancerHealthStatus(t *testing.T) {
	scheme := runtime.NewScheme()
	_ = k8gbv1beta1.AddToScheme(scheme)
	_ = corev1.AddToScheme(scheme)
	_ = discov1.AddToScheme(scheme)

	tests := []struct {
		name           string
		gslb           *k8gbv1beta1.Gslb
		service        *corev1.Service
		endpointSlices []discov1.EndpointSlice
		expectedStatus k8gbv1beta1.HealthStatus
		expectError    bool
	}{
		{
			name: "no load balancer service configured returns healthy",
			gslb: &k8gbv1beta1.Gslb{
				ObjectMeta: metav1.ObjectMeta{
					Name:      "test-gslb",
					Namespace: "test-ns",
				},
				Status: k8gbv1beta1.GslbStatus{
					LoadBalancer: k8gbv1beta1.LoadBalancer{
						Service: nil, // No service configured
					},
				},
			},
			expectedStatus: k8gbv1beta1.Healthy,
			expectError:    false,
		},
		{
			name: "service not found returns NotFound",
			gslb: &k8gbv1beta1.Gslb{
				ObjectMeta: metav1.ObjectMeta{
					Name:      "test-gslb",
					Namespace: "test-ns",
				},
				Status: k8gbv1beta1.GslbStatus{
					LoadBalancer: k8gbv1beta1.LoadBalancer{
						Service: &k8gbv1beta1.NamespacedName{
							Name:      "nonexistent-service",
							Namespace: "test-ns",
						},
					},
				},
			},
			expectedStatus: k8gbv1beta1.NotFound,
			expectError:    false,
		},
		{
			name: "service with no endpoint slices returns unhealthy",
			gslb: &k8gbv1beta1.Gslb{
				ObjectMeta: metav1.ObjectMeta{
					Name:      "test-gslb",
					Namespace: "test-ns",
				},
				Status: k8gbv1beta1.GslbStatus{
					LoadBalancer: k8gbv1beta1.LoadBalancer{
						Service: &k8gbv1beta1.NamespacedName{
							Name:      "lb-service",
							Namespace: "test-ns",
						},
					},
				},
			},
			service: &corev1.Service{
				ObjectMeta: metav1.ObjectMeta{
					Name:      "lb-service",
					Namespace: "test-ns",
				},
			},
			endpointSlices: []discov1.EndpointSlice{},
			expectedStatus: k8gbv1beta1.Unhealthy,
			expectError:    false,
		},
		{
			name: "service with ready endpoints returns healthy",
			gslb: &k8gbv1beta1.Gslb{
				ObjectMeta: metav1.ObjectMeta{
					Name:      "test-gslb",
					Namespace: "test-ns",
				},
				Status: k8gbv1beta1.GslbStatus{
					LoadBalancer: k8gbv1beta1.LoadBalancer{
						Service: &k8gbv1beta1.NamespacedName{
							Name:      "lb-service",
							Namespace: "test-ns",
						},
					},
				},
			},
			service: &corev1.Service{
				ObjectMeta: metav1.ObjectMeta{
					Name:      "lb-service",
					Namespace: "test-ns",
					Labels: map[string]string{
						"app": "ingress",
					},
				},
			},
			endpointSlices: []discov1.EndpointSlice{
				{
					ObjectMeta: metav1.ObjectMeta{
						Name:      "lb-service-abc",
						Namespace: "test-ns",
						Labels: map[string]string{
							discov1.LabelServiceName: "lb-service",
						},
					},
					Endpoints: []discov1.Endpoint{
						{
							Addresses: []string{"10.0.0.1"},
							Conditions: discov1.EndpointConditions{
								Ready: boolPtr(true),
							},
						},
					},
				},
			},
			expectedStatus: k8gbv1beta1.Healthy,
			expectError:    false,
		},
		{
			name: "service with only not-ready endpoints returns unhealthy",
			gslb: &k8gbv1beta1.Gslb{
				ObjectMeta: metav1.ObjectMeta{
					Name:      "test-gslb",
					Namespace: "test-ns",
				},
				Status: k8gbv1beta1.GslbStatus{
					LoadBalancer: k8gbv1beta1.LoadBalancer{
						Service: &k8gbv1beta1.NamespacedName{
							Name:      "lb-service",
							Namespace: "test-ns",
						},
					},
				},
			},
			service: &corev1.Service{
				ObjectMeta: metav1.ObjectMeta{
					Name:      "lb-service",
					Namespace: "test-ns",
				},
			},
			endpointSlices: []discov1.EndpointSlice{
				{
					ObjectMeta: metav1.ObjectMeta{
						Name:      "lb-service-abc",
						Namespace: "test-ns",
						Labels: map[string]string{
							discov1.LabelServiceName: "lb-service",
						},
					},
					Endpoints: []discov1.Endpoint{
						{
							Addresses: []string{"10.0.0.1"},
							Conditions: discov1.EndpointConditions{
								Ready: boolPtr(false),
							},
						},
					},
				},
			},
			expectedStatus: k8gbv1beta1.Unhealthy,
			expectError:    false,
		},
		{
			name: "service with mixed ready and not-ready endpoints returns healthy",
			gslb: &k8gbv1beta1.Gslb{
				ObjectMeta: metav1.ObjectMeta{
					Name:      "test-gslb",
					Namespace: "test-ns",
				},
				Status: k8gbv1beta1.GslbStatus{
					LoadBalancer: k8gbv1beta1.LoadBalancer{
						Service: &k8gbv1beta1.NamespacedName{
							Name:      "lb-service",
							Namespace: "test-ns",
						},
					},
				},
			},
			service: &corev1.Service{
				ObjectMeta: metav1.ObjectMeta{
					Name:      "lb-service",
					Namespace: "test-ns",
				},
			},
			endpointSlices: []discov1.EndpointSlice{
				{
					ObjectMeta: metav1.ObjectMeta{
						Name:      "lb-service-abc",
						Namespace: "test-ns",
						Labels: map[string]string{
							discov1.LabelServiceName: "lb-service",
						},
					},
					Endpoints: []discov1.Endpoint{
						{
							Addresses: []string{"10.0.0.1"},
							Conditions: discov1.EndpointConditions{
								Ready: boolPtr(false),
							},
						},
						{
							Addresses: []string{"10.0.0.2"},
							Conditions: discov1.EndpointConditions{
								Ready: boolPtr(true),
							},
						},
					},
				},
			},
			expectedStatus: k8gbv1beta1.Healthy,
			expectError:    false,
		},
	}

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			// Setup fake client with objects
			var objs []runtime.Object
			if tt.service != nil {
				objs = append(objs, tt.service)
			}
			for i := range tt.endpointSlices {
				objs = append(objs, &tt.endpointSlices[i])
			}

			fakeClient := fake.NewClientBuilder().
				WithScheme(scheme).
				WithRuntimeObjects(objs...).
				Build()

			reconciler := &GslbReconciler{
				Client: fakeClient,
			}

			// Execute
			status, err := reconciler.getLoadBalancerHealthStatus(context.Background(), tt.gslb)

			// Assert
			if tt.expectError {
				assert.Error(t, err)
			} else {
				assert.NoError(t, err)
			}
			assert.Equal(t, tt.expectedStatus, status)
		})
	}
}

func TestGetServiceHealthStatusWithIngressControllerHealthCheck(t *testing.T) {
	scheme := runtime.NewScheme()
	_ = k8gbv1beta1.AddToScheme(scheme)
	_ = corev1.AddToScheme(scheme)
	_ = discov1.AddToScheme(scheme)

	tests := []struct {
		name                 string
		gslb                 *k8gbv1beta1.Gslb
		appService           *corev1.Service
		appEndpointSlices    []discov1.EndpointSlice
		featureEnabled       bool
		expectedHealthStatus map[string]k8gbv1beta1.HealthStatus
		expectError          bool
	}{
		{
			name: "feature disabled - only checks app health",
			gslb: &k8gbv1beta1.Gslb{
				ObjectMeta: metav1.ObjectMeta{
					Name:      "test-gslb",
					Namespace: "test-ns",
				},
				Status: k8gbv1beta1.GslbStatus{
					Servers: []*k8gbv1beta1.Server{
						{
							Host: "app.example.com",
							Services: []*k8gbv1beta1.NamespacedName{
								{
									Name:      "app-service",
									Namespace: "test-ns",
								},
							},
						},
					},
					LoadBalancer: k8gbv1beta1.LoadBalancer{
						Status: k8gbv1beta1.Unhealthy, // LB is unhealthy but feature is disabled
					},
				},
			},
			appService: &corev1.Service{
				ObjectMeta: metav1.ObjectMeta{
					Name:      "app-service",
					Namespace: "test-ns",
				},
			},
			appEndpointSlices: []discov1.EndpointSlice{
				{
					ObjectMeta: metav1.ObjectMeta{
						Name:      "app-service-abc",
						Namespace: "test-ns",
						Labels: map[string]string{
							discov1.LabelServiceName: "app-service",
						},
					},
					Endpoints: []discov1.Endpoint{
						{
							Addresses: []string{"10.0.0.1"},
							Conditions: discov1.EndpointConditions{
								Ready: boolPtr(true),
							},
						},
					},
				},
			},
			featureEnabled: false,
			expectedHealthStatus: map[string]k8gbv1beta1.HealthStatus{
				"app.example.com": k8gbv1beta1.Healthy, // Should be healthy since feature is off
			},
			expectError: false,
		},
		{
			name: "feature enabled - both app and LB healthy",
			gslb: &k8gbv1beta1.Gslb{
				ObjectMeta: metav1.ObjectMeta{
					Name:      "test-gslb",
					Namespace: "test-ns",
				},
				Status: k8gbv1beta1.GslbStatus{
					Servers: []*k8gbv1beta1.Server{
						{
							Host: "app.example.com",
							Services: []*k8gbv1beta1.NamespacedName{
								{
									Name:      "app-service",
									Namespace: "test-ns",
								},
							},
						},
					},
					LoadBalancer: k8gbv1beta1.LoadBalancer{
						Status: k8gbv1beta1.Healthy,
					},
				},
			},
			appService: &corev1.Service{
				ObjectMeta: metav1.ObjectMeta{
					Name:      "app-service",
					Namespace: "test-ns",
				},
			},
			appEndpointSlices: []discov1.EndpointSlice{
				{
					ObjectMeta: metav1.ObjectMeta{
						Name:      "app-service-abc",
						Namespace: "test-ns",
						Labels: map[string]string{
							discov1.LabelServiceName: "app-service",
						},
					},
					Endpoints: []discov1.Endpoint{
						{
							Addresses: []string{"10.0.0.1"},
							Conditions: discov1.EndpointConditions{
								Ready: boolPtr(true),
							},
						},
					},
				},
			},
			featureEnabled: true,
			expectedHealthStatus: map[string]k8gbv1beta1.HealthStatus{
				"app.example.com": k8gbv1beta1.Healthy,
			},
			expectError: false,
		},
		{
			name: "feature enabled - app healthy but LB unhealthy",
			gslb: &k8gbv1beta1.Gslb{
				ObjectMeta: metav1.ObjectMeta{
					Name:      "test-gslb",
					Namespace: "test-ns",
				},
				Status: k8gbv1beta1.GslbStatus{
					Servers: []*k8gbv1beta1.Server{
						{
							Host: "app.example.com",
							Services: []*k8gbv1beta1.NamespacedName{
								{
									Name:      "app-service",
									Namespace: "test-ns",
								},
							},
						},
					},
					LoadBalancer: k8gbv1beta1.LoadBalancer{
						Status: k8gbv1beta1.Unhealthy, // LB is unhealthy
					},
				},
			},
			appService: &corev1.Service{
				ObjectMeta: metav1.ObjectMeta{
					Name:      "app-service",
					Namespace: "test-ns",
				},
			},
			appEndpointSlices: []discov1.EndpointSlice{
				{
					ObjectMeta: metav1.ObjectMeta{
						Name:      "app-service-abc",
						Namespace: "test-ns",
						Labels: map[string]string{
							discov1.LabelServiceName: "app-service",
						},
					},
					Endpoints: []discov1.Endpoint{
						{
							Addresses: []string{"10.0.0.1"},
							Conditions: discov1.EndpointConditions{
								Ready: boolPtr(true),
							},
						},
					},
				},
			},
			featureEnabled: true,
			expectedHealthStatus: map[string]k8gbv1beta1.HealthStatus{
				"app.example.com": k8gbv1beta1.Unhealthy, // Should be unhealthy due to LB
			},
			expectError: false,
		},
		{
			name: "feature enabled - app unhealthy, LB healthy",
			gslb: &k8gbv1beta1.Gslb{
				ObjectMeta: metav1.ObjectMeta{
					Name:      "test-gslb",
					Namespace: "test-ns",
				},
				Status: k8gbv1beta1.GslbStatus{
					Servers: []*k8gbv1beta1.Server{
						{
							Host: "app.example.com",
							Services: []*k8gbv1beta1.NamespacedName{
								{
									Name:      "app-service",
									Namespace: "test-ns",
								},
							},
						},
					},
					LoadBalancer: k8gbv1beta1.LoadBalancer{
						Status: k8gbv1beta1.Healthy,
					},
				},
			},
			appService: &corev1.Service{
				ObjectMeta: metav1.ObjectMeta{
					Name:      "app-service",
					Namespace: "test-ns",
				},
			},
			appEndpointSlices: []discov1.EndpointSlice{
				{
					ObjectMeta: metav1.ObjectMeta{
						Name:      "app-service-abc",
						Namespace: "test-ns",
						Labels: map[string]string{
							discov1.LabelServiceName: "app-service",
						},
					},
					Endpoints: []discov1.Endpoint{
						{
							Addresses: []string{"10.0.0.1"},
							Conditions: discov1.EndpointConditions{
								Ready: boolPtr(false), // App endpoint not ready
							},
						},
					},
				},
			},
			featureEnabled: true,
			expectedHealthStatus: map[string]k8gbv1beta1.HealthStatus{
				"app.example.com": k8gbv1beta1.Unhealthy, // Unhealthy due to app
			},
			expectError: false,
		},
		{
			name: "feature enabled - both app and LB unhealthy",
			gslb: &k8gbv1beta1.Gslb{
				ObjectMeta: metav1.ObjectMeta{
					Name:      "test-gslb",
					Namespace: "test-ns",
				},
				Status: k8gbv1beta1.GslbStatus{
					Servers: []*k8gbv1beta1.Server{
						{
							Host: "app.example.com",
							Services: []*k8gbv1beta1.NamespacedName{
								{
									Name:      "app-service",
									Namespace: "test-ns",
								},
							},
						},
					},
					LoadBalancer: k8gbv1beta1.LoadBalancer{
						Status: k8gbv1beta1.Unhealthy,
					},
				},
			},
			appService: &corev1.Service{
				ObjectMeta: metav1.ObjectMeta{
					Name:      "app-service",
					Namespace: "test-ns",
				},
			},
			appEndpointSlices: []discov1.EndpointSlice{},
			featureEnabled:    true,
			expectedHealthStatus: map[string]k8gbv1beta1.HealthStatus{
				"app.example.com": k8gbv1beta1.Unhealthy,
			},
			expectError: false,
		},
	}

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			// Setup fake client with objects
			var objs []runtime.Object
			if tt.appService != nil {
				objs = append(objs, tt.appService)
			}
			for i := range tt.appEndpointSlices {
				objs = append(objs, &tt.appEndpointSlices[i])
			}

			fakeClient := fake.NewClientBuilder().
				WithScheme(scheme).
				WithRuntimeObjects(objs...).
				Build()

			reconciler := &GslbReconciler{
				Client: fakeClient,
				Config: &resolver.Config{
					IngressControllerHealthCheckEnabled: tt.featureEnabled,
				},
			}

			// Execute
			healthStatus, err := reconciler.getServiceHealthStatus(context.Background(), tt.gslb)

			// Assert
			if tt.expectError {
				require.Error(t, err)
			} else {
				require.NoError(t, err)
				assert.Equal(t, tt.expectedHealthStatus, healthStatus)
			}
		})
	}
}

// Helper function to create bool pointers
func boolPtr(b bool) *bool {
	return &b
}
