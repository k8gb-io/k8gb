# Copyright 2021 The k8gb Contributors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# Generated by GoLic, for more details see: https://github.com/AbsaOSS/golic

JEKYLL_VERSION = 4.2.0
PWD ?=  $(shell pwd)
JEKYLL_PORT ?= 4000

# Bootstrap env vars from "dotenv" file
ifneq ($(wildcard ./.env),)
	include .env
	export
endif

# Build and serve k8gb.io website locally with watch and livereload
.PHONY: serve
serve:
	@echo "Building and serving k8gb.io website at http://localhost:$(JEKYLL_PORT) âŒ› ..."
ifneq ($(JEKYLL_GITHUB_TOKEN),)
	@docker run --rm -it \
		--env JEKYLL_GITHUB_TOKEN=$(JEKYLL_GITHUB_TOKEN) \
		--volume="$(PWD):/srv/jekyll" \
		--volume="$(PWD)/vendor/bundle:/usr/local/bundle" \
		-p 4000:4000 -p 35729:35729 jekyll/jekyll:$(JEKYLL_VERSION) \
		sh -c "jekyll serve --host 0.0.0.0 --watch --livereload --incremental"
else
	@echo "GitHub pages are using the GitHub API to obtain repository metadata for the website generation."
	@echo "Local generation requires a GitHub PAT token with the 'public_repo' scope (https://github.com/settings/tokens/new)."
	@echo "The token should be assigned to the JEKYLL_GITHUB_TOKEN environment variable."
endif

# Used from Netflify context
.PHONY: netlify-build
netlify-build:
	git checkout - {README,CONTRIBUTING,CHANGELOG}.md docs/ && \
	mv CNAME EMANC && bundle install && bundle exec jekyll build
